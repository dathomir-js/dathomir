---
applyTo: '**'
---

# Implementation Plan

VNode â†’ Fine-grained Reactivity å…¨é¢ç§»è¡Œã®å®Ÿè£…è¨ˆç”»ã€‚

SPEC.typ ã«åŸºã¥ãã€VNode ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ SolidJS ã‚¹ã‚¿ã‚¤ãƒ«ã® Fine-grained Reactivity + Direct DOM ã¸ã®å®Œå…¨ãªæ›¸ãç›´ã—ã‚’è¡Œã„ã¾ã™ã€‚æ§‹é€ åŒ–é…åˆ—æ–¹å¼ï¼ˆSvelte 5 ã® `from_tree` ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰ã‚’æ¡ç”¨ã—ã€TC39 Signals API ã¨ alien-signals ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º < 2KB ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

## ç¾çŠ¶åˆ†æ

- **reactivity**: signal/computed/effect/batch ãŒå®Ÿè£…æ¸ˆã¿ï¼ˆ469è¡Œã€ãƒ†ã‚¹ãƒˆã‚ã‚Šï¼‰ã€‚ãŸã ã— `createRoot` ãŒæœªå®Ÿè£…
- **runtime**: å®Œå…¨ã«ç©ºï¼ˆ14å€‹ã®é–¢æ•°ã‚’æ–°è¦å®Ÿè£…ï¼‰
- **transformer**: å®Œå…¨ã«ç©ºï¼ˆæ§‹é€ åŒ–é…åˆ—ã¸ã®å¤‰æ›ã‚’æ–°è¦å®Ÿè£…ï¼‰
- **plugin**: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ã¿ï¼ˆtransformer çµ±åˆãŒå¿…è¦ï¼‰
- **core**: reactivity ã¨ shared ã‚’å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- **playgrounds**: ç©ºï¼ˆå‹•ä½œæ¤œè¨¼ç’°å¢ƒãŒå¿…è¦ï¼‰

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¦ç‚¹

- ä¾å­˜é †åº: reactivity â†’ runtime â†’ transformer â†’ plugin â†’ core
- CSR å®Œäº†å¾Œã« SSR + Hydration ã‚’å®Ÿè£…
- å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½

---

## Phase 1: åŸºç¤å®Ÿè£…ï¼ˆCSR ã®ã¿å‹•ä½œï¼‰

### 1.1 Reactivity ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å®Œæˆ

**ç›®çš„**: `createRoot` ã‚’è¿½åŠ ã—ã€Owner/Root ãƒ™ãƒ¼ã‚¹ã® cleanup ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®Ÿè£…

**å®Ÿè£…å†…å®¹**:
- `packages/reactivity/src/index.ts` ã« `createRoot` é–¢æ•°ã‚’è¿½åŠ 
  - Owner ã‚¹ã‚¿ãƒƒã‚¯ã‚’ç®¡ç†ã™ã‚‹å†…éƒ¨å¤‰æ•°ã‚’è¿½åŠ 
  - `createRoot(fn)` ã¯æ–°ã—ã„ cleanup ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä½œæˆã—ã€dispose é–¢æ•°ã‚’è¿”ã™
  - `effect` ã¨ `templateEffect` ãŒç¾åœ¨ã® owner ã«è‡ªå‹•ç™»éŒ²ã•ã‚Œã‚‹ã‚ˆã†ä¿®æ­£
- `templateEffect` é–¢æ•°ã‚’è¿½åŠ 
  - `effect` ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ã® effectï¼ˆbatched flush å¯¾å¿œï¼‰
  - Runtime ãŒä½¿ç”¨ã™ã‚‹å°‚ç”¨ API
- `packages/reactivity/test/` ã« `createRoot.test.ts` ã¨ `templateEffect.test.ts` ã‚’è¿½åŠ 
- æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª

**ç ´å£Šçš„å¤‰æ›´**: ãªã—ï¼ˆAPI è¿½åŠ ã®ã¿ï¼‰

**æ¨å®šå·¥æ•°**: 2-3æ—¥

### 1.2 Runtime ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å®Ÿè£…

**ç›®çš„**: 14å€‹ã® Runtime é–¢æ•°ã‚’å®Ÿè£…ï¼ˆCSR ã®ã¿ã€SSR ã¯å¾Œå›ã—ï¼‰

**å®Ÿè£…å†…å®¹**:
- `packages/runtime/src/` ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
  - `dom/fromTree.ts`: æ§‹é€ åŒ–é…åˆ—ã‹ã‚‰ DOM ã‚’ç”Ÿæˆ
  - `dom/navigation.ts`: firstChild, nextSibling
  - `dom/text.ts`: setText
  - `dom/attr.ts`: setAttr, setProp
  - `dom/spread.ts`: spread
  - `dom/insertion.ts`: append, insert
  - `reconcile/index.ts`: reconcileï¼ˆkeyed list ã®å·®åˆ†æ›´æ–°ï¼‰
  - `reactivity/index.ts`: templateEffect, createRoot ã®å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  - `events/index.ts`: event
  - `types/tree.ts`: æ§‹é€ åŒ–é…åˆ—ã®å‹å®šç¾©
- `packages/runtime/src/index.ts` ã§å…¨é–¢æ•°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- `packages/runtime/test/` ã«å„æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼š
  - `dom/fromTree.test.ts`
  - `dom/navigation.test.ts`
  - `reconcile.test.ts`
  - `spread.test.ts`

**å®Ÿè£…ã®æ³¨æ„ç‚¹**:
- `fromTree` ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆ`{text}`, `{insert}`, `{each}` ç­‰ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€é™çš„éƒ¨åˆ†ã®ã¿ç”Ÿæˆ
- `reconcile` ã¯ keyed/unkeyed ã‚’åˆ¤å®šã—ã€åŠ¹ç‡çš„ãªå·®åˆ†é©ç”¨
- `spread` ã¯å‰å›ã® props ã¨å·®åˆ†ã‚’å–ã‚Šã€å¤‰æ›´ã•ã‚ŒãŸå±æ€§ã®ã¿æ›´æ–°
- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©åˆ¤å®š: `key.startsWith('on') && key.length > 2 && typeof value === 'function'`
- CSR å®Ÿè£…ã«é›†ä¸­ï¼ˆSSR/Hydration ã¯ Phase 2ï¼‰

**ç ´å£Šçš„å¤‰æ›´**: æ—¢å­˜ã® runtime ãŒãªã„ãŸã‚ã€å…¨ã¦æ–°è¦

**æ¨å®šå·¥æ•°**: 7-10æ—¥

### 1.3 Transformer ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å®Ÿè£…

**ç›®çš„**: JSX â†’ æ§‹é€ åŒ–é…åˆ—ã¸ã®å¤‰æ›ã‚’å®Ÿè£…

**å®Ÿè£…å†…å®¹**:
- `packages/transformer/src/` ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
  - `transform.ts`: ãƒ¡ã‚¤ãƒ³å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
  - `structuredArray.ts`: JSX ã‚’æ§‹é€ åŒ–é…åˆ—ï¼ˆTreeï¼‰ã«å¤‰æ›
  - `codeGen.ts`: Runtime å‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆ
  - `types.ts`: TransformOptions, TransformResult ã®å‹å®šç¾©
- `packages/transformer/src/index.ts` ã§ `transform` é–¢æ•°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- `packages/transformer/test/` ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼š
  - `transform.test.ts`: åŸºæœ¬çš„ãªå¤‰æ›
  - `computed-wrapping.test.ts`: props å€¤ã® `computed()` ãƒ©ãƒƒãƒ”ãƒ³ã‚°
  - `control-flow.test.ts`: if/each/Fragment ã®å¤‰æ›

**å¤‰æ›ä¾‹**:
```javascript
// å…¥åŠ›: <button class="btn" onClick={handler}>Count: {count.value}</button>
// å‡ºåŠ›:
const _t1 = fromTree([['button', { class: 'btn' }, 'Count: ', ['{text}', null]]], 0);
const button = firstChild(_t1());
const text = nextSibling(firstChild(button, true));
event('click', button, handler);
templateEffect(() => setText(text, count.value));
```

**å®Ÿè£…ã®æ³¨æ„ç‚¹**:
- JSX ã¯æ—¢ã« JavaScript ã«å¤‰æ›æ¸ˆã¿ã¨ä»®å®šï¼ˆbabel/swc ãŒå…ˆã«å‡¦ç†ï¼‰
- props å€¤ãŒ Signal ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆ`.value`ï¼‰ã‚’å«ã‚€å ´åˆã¯ `computed()` ã§ãƒ©ãƒƒãƒ—
- é™çš„ãªå€¤ï¼ˆãƒªãƒ†ãƒ©ãƒ«ï¼‰ã¯ãƒ©ãƒƒãƒ—ã—ãªã„
- CSR ãƒ¢ãƒ¼ãƒ‰ã®ã¿å®Ÿè£…ï¼ˆSSR ã¯ Phase 2ï¼‰

**ç ´å£Šçš„å¤‰æ›´**: æ—¢å­˜ã® transformer ãŒãªã„ãŸã‚ã€å…¨ã¦æ–°è¦

**æ¨å®šå·¥æ•°**: 5-7æ—¥

### 1.4 Plugin ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å®Ÿè£…

**ç›®çš„**: Vite/webpack çµ±åˆã‚’å®Ÿè£…ã—ã€transformer ã‚’å‘¼ã³å‡ºã™

**å®Ÿè£…å†…å®¹**:
- `packages/plugin/src/index.ts` ã‚’æ›¸ãæ›ãˆï¼š
  - `transform` é–¢æ•°ã§ `@dathomir/transformer` ã‚’å‘¼ã³å‡ºã™
  - Vite Environment API ã§ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆv1.0 ã¯ CSR ã®ã¿ãªã®ã§ã€SSR åˆ¤å®šã¯æº–å‚™ã®ã¿ï¼‰
  - JSX/TSX ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å¤‰æ›å¯¾è±¡ã¨ã™ã‚‹
- `packages/plugin/test/` ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼š
  - `plugin.test.ts`: åŸºæœ¬çš„ãªå¤‰æ›
  - `filter.test.ts`: include/exclude ãƒ‘ã‚¿ãƒ¼ãƒ³

**å®Ÿè£…ã®æ³¨æ„ç‚¹**:
- unplugin ã‚’ä½¿ç”¨ã—ã€Vite/webpack ä¸¡å¯¾å¿œ
- CSR ãƒ¢ãƒ¼ãƒ‰ã®ã¿ã‚µãƒãƒ¼ãƒˆï¼ˆSSR ã¯ Phase 2ï¼‰
- Environment API ã®å„ªå…ˆé †ä½: `environment.name` â†’ `options.ssr` â†’ `import.meta.env.SSR`

**ç ´å£Šçš„å¤‰æ›´**: æ—¢å­˜ã® plugin ã‚’å®Œå…¨ã«ç½®ãæ›ãˆ

**æ¨å®šå·¥æ•°**: 2-3æ—¥

### 1.5 Core ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°

**ç›®çš„**: runtime ã‚’çµ±åˆã—ã€å…¬é–‹ API ã‚’æ•´ãˆã‚‹

**å®Ÿè£…å†…å®¹**:
- `packages/core/src/index.ts` ã« runtime ã®å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
- `packages/core/src/runtime/index.ts` ã‚’ä½œæˆã—ã€runtime é–¢æ•°ã‚’å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- README ã‚’æ›´æ–°ã—ã€ä½¿ç”¨ä¾‹ã‚’è¿½åŠ 

**ç ´å£Šçš„å¤‰æ›´**: ãªã—ï¼ˆAPI è¿½åŠ ã®ã¿ï¼‰

**æ¨å®šå·¥æ•°**: 1æ—¥

### 1.6 Playground ã®ä½œæˆ

**ç›®çš„**: CSR å‹•ä½œã‚’æ¤œè¨¼ã™ã‚‹ playground ã‚’ä½œæˆ

**å®Ÿè£…å†…å®¹**:
- `playgrounds/vanilla/` ã«ç°¡å˜ãªã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã‚’ä½œæˆ
  - `index.html`, `main.ts`, `Counter.tsx`
  - Vite ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  - `@dathomir/plugin` ã‚’ä½¿ç”¨

**å‹•ä½œç¢ºèªé …ç›®**ï¼š
- Signal ã®æ›´æ–°ãŒ DOM ã«åæ˜ ã•ã‚Œã‚‹
- ã‚¤ãƒ™ãƒ³ãƒˆãŒå‹•ä½œã™ã‚‹
- ãƒªã‚¹ãƒˆï¼ˆreconcileï¼‰ãŒå‹•ä½œã™ã‚‹
- cleanup ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‰Šé™¤æ™‚ï¼‰

**æ¨å®šå·¥æ•°**: 1-2æ—¥

### Phase 1 å®Œäº†æ¡ä»¶

- [ ] reactivity: `createRoot` ã¨ `templateEffect` ãŒå®Ÿè£…ã•ã‚Œã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] runtime: 14å€‹ã®é–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã€å˜ä½“ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] transformer: JSX â†’ æ§‹é€ åŒ–é…åˆ—å¤‰æ›ãŒå‹•ä½œã—ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] plugin: Vite ã§å‹•ä½œã—ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] playground: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªãŒ CSR ã§å‹•ä½œã™ã‚‹

**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**:
```bash
pnpm --filter @dathomir/reactivity test
pnpm --filter @dathomir/runtime test
pnpm --filter @dathomir/transformer test
pnpm --filter @dathomir/plugin test
pnpm --filter vanilla dev
```

**Phase 1 æ¨å®šç·å·¥æ•°**: 18-26æ—¥

---

## Phase 2: SSR + Hydration

### 2.1 Runtime ã® SSR å¯¾å¿œ

**ç›®çš„**: Runtime ã« SSR ç”¨ã®é–¢æ•°ã‚’è¿½åŠ 

**å®Ÿè£…å†…å®¹**:
- `packages/runtime/src/ssr/` ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
  - `render.ts`: æ§‹é€ åŒ–é…åˆ—ã‹ã‚‰ HTML æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
  - `markers.ts`: SSR ãƒãƒ¼ã‚«ãƒ¼ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆ/å±æ€§ï¼‰ã®ç”Ÿæˆ
  - `serialize.ts`: çŠ¶æ…‹ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆdevalue ä½¿ç”¨ï¼‰
- `packages/runtime/src/index.ts` ã§ SSR é–¢æ•°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- `packages/runtime/test/ssr/` ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 

**å®Ÿè£…ã®æ³¨æ„ç‚¹**:
- Web æ¨™æº– API ã®ã¿ä½¿ç”¨ï¼ˆNode.js ä¾å­˜ã‚¼ãƒ­ï¼‰
- devalue ã‚’ä½¿ç”¨ã—ã¦çŠ¶æ…‹ã‚’å®‰å…¨ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
- Declarative Shadow DOM ã‚’å„ªå…ˆçš„ã«ç”Ÿæˆ

**ç ´å£Šçš„å¤‰æ›´**: ãªã—ï¼ˆAPI è¿½åŠ ã®ã¿ï¼‰

**æ¨å®šå·¥æ•°**: 5-7æ—¥

### 2.2 Runtime ã® Hydration å¯¾å¿œ

**ç›®çš„**: SSR ç”Ÿæˆã® DOM ã‚’ Hydration ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ 

**å®Ÿè£…å†…å®¹**:
- `packages/runtime/src/hydration/` ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
  - `hydrate.ts`: Hydration ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
  - `walker.ts`: TreeWalker ã«ã‚ˆã‚‹ãƒãƒ¼ã‚«ãƒ¼æ¢ç´¢
  - `deserialize.ts`: çŠ¶æ…‹ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆdevalue ä½¿ç”¨ï¼‰
  - `markers.ts`: ãƒãƒ¼ã‚«ãƒ¼ã®è§£é‡ˆ
- WeakMap ã§ Hydration æ¸ˆã¿ ShadowRoot ã‚’ç®¡ç†ï¼ˆå†ªç­‰æ€§ä¿è¨¼ï¼‰
- `packages/runtime/test/hydration/` ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 

**å®Ÿè£…ã®æ³¨æ„ç‚¹**:
- TreeWalker ã§ç·šå½¢æ¢ç´¢
- effect ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŒæ™‚ã«æ¥ç¶š
- é–‹ç™ºç’°å¢ƒã§ãƒŸã‚¹ãƒãƒƒãƒã‚’æ¤œå‡ºã—ã€ä¾‹å¤–ã‚’æŠ•ã’ã‚‹
- æœ¬ç•ªç’°å¢ƒã§ã¯è­¦å‘Šã‚’å‡ºã—ã€CSR ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ç ´å£Šçš„å¤‰æ›´**: ãªã—ï¼ˆAPI è¿½åŠ ã®ã¿ï¼‰

**æ¨å®šå·¥æ•°**: 5-7æ—¥

### 2.3 Transformer ã® SSR å¯¾å¿œ

**ç›®çš„**: SSR ãƒ¢ãƒ¼ãƒ‰ã§ã®ç•°ãªã‚‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

**å®Ÿè£…å†…å®¹**:
- `packages/transformer/src/ssr.ts` ã‚’ä½œæˆï¼š
  - SSR ç”¨ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒãƒ¼ã‚«ãƒ¼ä»˜ã HTML æ–‡å­—åˆ—ç”Ÿæˆï¼‰
  - çŠ¶æ…‹ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
- `packages/transformer/src/transform.ts` ã‚’æ›´æ–°ï¼š
  - `options.mode` ã§ CSR/SSR ã‚’åˆ¤å®šã—ã€é©åˆ‡ãªå¤‰æ›ã‚’é¸æŠ
- `packages/transformer/test/ssr.test.ts` ã‚’è¿½åŠ 

**å®Ÿè£…ã®æ³¨æ„ç‚¹**:
- SSR ã§ã¯æ§‹é€ åŒ–é…åˆ—ã‹ã‚‰ HTML æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
- ãƒãƒ¼ã‚«ãƒ¼ã‚’é©åˆ‡ã«æŒ¿å…¥
- Signal ã®åˆæœŸå€¤ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

**ç ´å£Šçš„å¤‰æ›´**: ãªã—ï¼ˆæ—¢å­˜ã® CSR ã‚³ãƒ¼ãƒ‰ã«å½±éŸ¿ãªã—ï¼‰

**æ¨å®šå·¥æ•°**: 3-4æ—¥

### 2.4 Plugin ã® SSR å¯¾å¿œ

**ç›®çš„**: Environment API ã§ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šã—ã€transformer ã« SSR ãƒ¢ãƒ¼ãƒ‰ã‚’æ¸¡ã™

**å®Ÿè£…å†…å®¹**:
- `packages/plugin/src/index.ts` ã‚’æ›´æ–°ï¼š
  - Environment API ã§ç’°å¢ƒåˆ¤å®šï¼ˆ`client`, `ssr`, `edge`ï¼‰
  - transformer ã« `options.mode` ã‚’æ¸¡ã™
- `packages/plugin/test/ssr.test.ts` ã‚’è¿½åŠ 

**å®Ÿè£…ã®æ³¨æ„ç‚¹**:
- å„ªå…ˆé †ä½: `environment.name` â†’ `options.ssr` â†’ `import.meta.env.SSR`
- `edge` ç’°å¢ƒã‚‚ SSR ã¨ã—ã¦æ‰±ã†

**ç ´å£Šçš„å¤‰æ›´**: ãªã—ï¼ˆæ—¢å­˜ã® CSR ã‚³ãƒ¼ãƒ‰ã«å½±éŸ¿ãªã—ï¼‰

**æ¨å®šå·¥æ•°**: 2-3æ—¥

### 2.5 SSR Playground ã®ä½œæˆ

**ç›®çš„**: SSR + Hydration ã®å‹•ä½œã‚’æ¤œè¨¼

**å®Ÿè£…å†…å®¹**:
- `playgrounds/ssr/` ã‚’ä½œæˆï¼š
  - `server.ts`: SSR ã‚µãƒ¼ãƒãƒ¼
  - `client.ts`: Hydration ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
  - `App.tsx`: ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒª

**å‹•ä½œç¢ºèªé …ç›®**ï¼š
- SSR ã§ HTML ãŒç”Ÿæˆã•ã‚Œã‚‹
- Hydration ã§æ—¢å­˜ DOM ãŒå†åˆ©ç”¨ã•ã‚Œã‚‹
- ã‚¤ãƒ™ãƒ³ãƒˆãŒå‹•ä½œã™ã‚‹
- Signal ã®æ›´æ–°ãŒ DOM ã«åæ˜ ã•ã‚Œã‚‹
- äºŒé‡åˆæœŸåŒ–ãŒç™ºç”Ÿã—ãªã„

**æ¨å®šå·¥æ•°**: 2-3æ—¥

### Phase 2 å®Œäº†æ¡ä»¶

- [ ] runtime: SSR ã¨ Hydration ã®é–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] transformer: SSR ãƒ¢ãƒ¼ãƒ‰ã§ãƒãƒ¼ã‚«ãƒ¼ä»˜ã HTML ãŒç”Ÿæˆã•ã‚Œã‚‹
- [ ] plugin: Environment API ã§ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šãŒå‹•ä½œã™ã‚‹
- [ ] playground: SSR ã‚¢ãƒ—ãƒªãŒå‹•ä½œã—ã€Hydration ãŒæˆåŠŸã™ã‚‹

**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**:
```bash
pnpm --filter @dathomir/runtime test:ssr
pnpm --filter @dathomir/transformer test:ssr
pnpm --filter ssr dev
```

**Phase 2 æ¨å®šç·å·¥æ•°**: 15-21æ—¥

---

## Phase 3: æœ€é©åŒ–ã¨ãƒãƒªãƒƒã‚·ãƒ¥

### 3.1 ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®æœ€é©åŒ–

**ç›®çš„**: Runtime ã®ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’ < 2KB ã«æŠ‘ãˆã‚‹

**å®Ÿè£…å†…å®¹**:
- `packages/runtime/` ã®ã‚³ãƒ¼ãƒ‰ã‚’æœ€é©åŒ–ï¼š
  - ä¸è¦ãªæŠ½è±¡åŒ–ã‚’å‰Šé™¤
  - é–¢æ•°ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
  - Tree shaking ã‚’è€ƒæ…®ã—ãŸã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’æ¸¬å®šã—ã€ç›®æ¨™é”æˆã‚’ç¢ºèª
  - `fromTree` + navigation + text + attr + events: ~800B
  - `spread`: ~150B
  - `reconcile`: ~400B
  - `templateEffect` + `createRoot`: ~350B
  - åˆè¨ˆç›®æ¨™: ~1.6KBï¼ˆãƒãƒ¼ã‚¸ãƒ³ ~400Bï¼‰

**æ¨å®šå·¥æ•°**: 2-3æ—¥

### 3.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

**ç›®çš„**: å®Ÿéš›ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®šã—ã€ç›®æ¨™é”æˆã‚’ç¢ºèª

**å®Ÿè£…å†…å®¹**:
- `packages/runtime/test/bench/` ã«ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è¿½åŠ ï¼š
  - `fromTree-bench.ts`: DOM ç”Ÿæˆé€Ÿåº¦
  - `reconcile-bench.ts`: ãƒªã‚¹ãƒˆå·®åˆ†é€Ÿåº¦
  - `reactivity-bench.ts`: ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
- ç›®æ¨™ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆVNode æ¯”ï¼‰: 3-5x å‘ä¸Š

**æ¨å®šå·¥æ•°**: 1-2æ—¥

### 3.3 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™

**ç›®çš„**: å…¬é–‹ã«å‘ã‘ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ•´å‚™

**å®Ÿè£…å†…å®¹**:
- å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® README ã‚’æ›´æ–°ï¼š
  - ä½¿ç”¨ä¾‹
  - API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
  - åˆ¶ç´„äº‹é …
- `SPEC/SPEC.typ` ã‚’æœ€æ–°ã®å®Ÿè£…ã«åˆã‚ã›ã¦æ›´æ–°
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆï¼ˆVNode ã‹ã‚‰ã®ç§»è¡Œï¼‰

**æ¨å®šå·¥æ•°**: 2-3æ—¥

### 3.4 é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã®è¨ºæ–­æƒ…å ±

**ç›®çš„**: é–‹ç™ºè€…ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹

**å®Ÿè£…å†…å®¹**:
- `packages/runtime/src/` ã«é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼š
  - Hydration ãƒŸã‚¹ãƒãƒƒãƒã®è©³ç´°æƒ…å ±
  - ç„¡é™ãƒ«ãƒ¼ãƒ—ã®æ¤œå‡º
  - é©åˆ‡ãªè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `__DEV__` ãƒ•ãƒ©ã‚°ã§æ¡ä»¶åˆ†å²ã—ã€æœ¬ç•ªã§ã¯é™¤å¤–

**æ¨å®šå·¥æ•°**: 1-2æ—¥

### Phase 3 å®Œäº†æ¡ä»¶

- [ ] ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º: runtime < 2KBï¼ˆgzip å¾Œï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: VNode æ¯” 3-5x å‘ä¸Š
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® README ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹
- [ ] é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: é©åˆ‡ãªè­¦å‘Šã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**:
```bash
pnpm build
pnpm --filter @dathomir/runtime size-limit
pnpm --filter @dathomir/runtime bench
```

**Phase 3 æ¨å®šç·å·¥æ•°**: 6-10æ—¥

---

## æ¨å®šç·å·¥æ•°

- **Phase 1**: 18-26æ—¥
- **Phase 2**: 15-21æ—¥
- **Phase 3**: 6-10æ—¥
- **åˆè¨ˆ**: 39-57æ—¥ï¼ˆç´„2-3ãƒ¶æœˆï¼‰

---

## é‡è¦ãªæ³¨æ„ç‚¹ã¨ãƒªã‚¹ã‚¯

### ğŸ”´ é«˜é›£åº¦ç®‡æ‰€

1. **reconcile ã®å®Ÿè£…** - keyed list ã®åŠ¹ç‡çš„ãªå·®åˆ†è¨ˆç®—ã¯è¤‡é›‘ã€‚SolidJS ã‚„ Svelte ã®å®Ÿè£…ã‚’å‚è€ƒã«ã™ã‚‹ã€‚
2. **Hydration ã®ãƒãƒ¼ã‚«ãƒ¼æ¢ç´¢** - TreeWalker ã®æ­£ã—ã„ä½¿ç”¨ã¨ã€ãƒŸã‚¹ãƒãƒƒãƒå‡¦ç†ã€‚é–‹ç™ºç’°å¢ƒã§ååˆ†ãªãƒ†ã‚¹ãƒˆãŒå¿…è¦ã€‚
3. **æ§‹é€ åŒ–é…åˆ—æ–¹å¼** - å®Ÿç¸¾ãŒå°‘ãªã„ãŸã‚ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã§äºˆæœŸã—ãªã„å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã€‚ä»£æ›¿æ¡ˆï¼ˆHTML String æ–¹å¼ï¼‰ã‚’å¸¸ã«å¿µé ­ã«ç½®ãã€‚

### âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼ãŒå¿…è¦ãªç®‡æ‰€

- `fromTree` ã® DOM ç”Ÿæˆé€Ÿåº¦ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã® HTML ãƒ‘ãƒ¼ã‚µãƒ¼ã‚ˆã‚Šé…ã„å¯èƒ½æ€§ï¼‰
- `reconcile` ã®å·®åˆ†è¨ˆç®—ï¼ˆO(n) ã ãŒå®šæ•°å€ãŒå¤§ãã„å¯èƒ½æ€§ï¼‰
- `templateEffect` ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼ˆbatched flush ã®å®Ÿè£…ï¼‰

### ğŸ“ ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºç›®æ¨™é”æˆã®ãŸã‚ã®æ³¨æ„ç‚¹

- Runtime ã®å„é–¢æ•°ã‚’æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿè£…
- ä¸è¦ãªæŠ½è±¡åŒ–ã‚’é¿ã‘ã‚‹
- Tree shaking ãŒåŠ¹ãã‚ˆã†ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’æ•´ç†
- å®šæœŸçš„ã«ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’æ¸¬å®šï¼ˆsize-limit ä½¿ç”¨ï¼‰

### ğŸ¯ å®Ÿè£…ã®å„ªå…ˆé †ä½

**Phase 1 å„ªå…ˆ**: CSR ã‚’å®Œå…¨ã«å‹•ä½œã•ã›ã‚‹ã“ã¨ã§ã€åŸºç¤ã‚’å›ºã‚ã‚‹ã€‚SSR ã¯åˆ¥ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€è¤‡é›‘æ€§ã‚’åˆ†é›¢ã€‚

**æ§‹é€ åŒ–é…åˆ—æ–¹å¼**: Svelte 5 ã® `from_tree` ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã€‚å®Ÿç¸¾ã¯å°‘ãªã„ãŒã€ç‹¬è‡ªæ€§ã¨æ‹¡å¼µæ€§ã‚’å„ªå…ˆã€‚ã‚‚ã—å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€HTML String æ–¹å¼ï¼ˆ`fromHtml`ï¼‰ã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ¤œè¨ï¼ˆADR ã«è¨˜è¼‰æ¸ˆã¿ï¼‰ã€‚

**ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º**: reconcile ã‚’ Runtime ã«å«ã‚ã‚‹ã“ã¨ã§ ~400B å¢—ãˆã‚‹ãŒã€å‡ºåŠ›ã‚³ãƒ¼ãƒ‰ã®ç°¡æ½”ã•ã‚’å„ªå…ˆã€‚ç›®æ¨™ 2KB ã¯é”æˆå¯èƒ½ã¨æ¨å®šã€‚

**ãƒ†ã‚¹ãƒˆæˆ¦ç•¥**: å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å¾¹åº•ã—ã€playground ã§çµ±åˆãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã€‚ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ 100% ã‚’ç›®æŒ‡ã™ãŒã€åˆæœŸã¯ä¸»è¦æ©Ÿèƒ½ã«é›†ä¸­ã€‚

**Edge ç’°å¢ƒ**: v1.0 ã‹ã‚‰ Node.js ä¾å­˜ã‚¼ãƒ­ã§å®Ÿè£…ã—ã€å¾Œã‹ã‚‰ã®ç ´å£Šçš„å¤‰æ›´ã‚’å›é¿ã€‚

---

## å®Ÿè£…æ™‚ã®å‚è€ƒè³‡æ–™

### ADR ã¨ã®å¯¾å¿œ

- **ADR: Transformer å‡ºåŠ›å½¢å¼** â†’ Phase 1.3 ã§æ§‹é€ åŒ–é…åˆ—æ–¹å¼ã‚’å®Ÿè£…
- **ADR: Runtime åŸèªã®æœ€å°ã‚»ãƒƒãƒˆ** â†’ Phase 1.2 ã§ 14 é–¢æ•°ã‚’å®Ÿè£…
- **ADR: Cleanup å¥‘ç´„** â†’ Phase 1.1 ã§ createRoot ã‚’å®Ÿè£…
- **ADR: çŠ¶æ…‹è»¢é€ã®ç¯„å›²** â†’ Phase 2.1/2.2 ã§ devalue ã‚’ä½¿ç”¨
- **ADR: Hydration æ¢ç´¢æˆ¦ç•¥** â†’ Phase 2.2 ã§ TreeWalker ã‚’ä½¿ç”¨
- **ADR: SSR ãƒ¢ãƒ¼ãƒ‰ä¼æ’­** â†’ Phase 2.4 ã§ Vite Environment API ã‚’ä½¿ç”¨

### Interface Spec ã¨ã®å¯¾å¿œ

- **SSR ãƒãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ãƒˆã‚³ãƒ«** â†’ Phase 2.1/2.2 ã§å®Ÿè£…
- **æ§‹é€ åŒ–é…åˆ—å½¢å¼ï¼ˆIRï¼‰** â†’ Phase 1.2/1.3 ã§å®Ÿè£…
- **Runtime API** â†’ Phase 1.2 ã§å®Ÿè£…
- **Reactivity API** â†’ Phase 1.1 ã§å®Œæˆ
- **Plugin API** â†’ Phase 1.4 ã§å®Ÿè£…
- **Transformer API** â†’ Phase 1.3 ã§å®Ÿè£…

### Behavior Spec ã¨ã®å¯¾å¿œ

- **Hydration** â†’ Phase 2.2 ã§å®Ÿè£…
- **Shadow DOM ç”Ÿæˆæˆ¦ç•¥** â†’ Phase 2.1/2.5 ã§å®Ÿè£…
- **Cleanup ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«** â†’ Phase 1.1 ã§å®Ÿè£…
- **Effect å®Ÿè¡Œ** â†’ Phase 1.1 ã§å®Ÿè£…
